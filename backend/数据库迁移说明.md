# 数据库迁移说明

## 概述

项目已从 Mock 数据模式迁移到 PostgreSQL 数据库模式，支持通过 DBeaver 进行可视化管理。

## 主要变更

### 1. 新增文件

- `backend/app/database.py` - 数据库连接配置
- `backend/app/db_models.py` - SQLAlchemy ORM 模型
- `backend/app/db_service.py` - 数据库服务层（替代 MockDataGenerator）
- `backend/app/init_database.py` - 数据库初始化脚本
- `backend/init_db.sql` - SQL 建表脚本
- `backend/DBeaver连接指南.md` - DBeaver 使用说明
- `backend/test_db_connection.py` - 数据库连接测试脚本

### 2. 修改文件

- `backend/requirements.txt` - 添加数据库依赖
  - `sqlalchemy` - ORM 框架
  - `psycopg2-binary` - PostgreSQL 驱动
  - `alembic` - 数据库迁移工具（可选）
  - `python-dotenv` - 环境变量管理

- `backend/app/main.py` - 添加数据库表自动创建
- `backend/app/api/routes.py` - 从数据库读取数据（替代 MockDataGenerator）
- `backend/app/modules/packing/estimator.py` - 支持外部传入 SKU 数据库
- `docker-compose.yml` - 添加 PostgreSQL 服务

### 3. 数据库表结构

#### `skus` 表
存储 SKU 基础信息（尺寸、重量等）

#### `orders` 表
存储订单主信息（订单号、客户、坐标、急单标识、状态等）

#### `order_items` 表
存储订单明细（订单与 SKU 的多对多关系）

## 使用方式

### 1. 启动数据库

```bash
# 启动所有服务（包括数据库）
docker-compose up -d

# 或仅启动数据库
docker-compose up -d postgres
```

### 2. 连接 DBeaver

参考 `backend/DBeaver连接指南.md` 进行配置。

**连接信息：**
- 主机: `localhost`
- 端口: `5432`
- 数据库: `dreo_logistics`
- 用户名: `dreo_user`
- 密码: `dreo_password`

### 3. 插入数据

#### 方式一：通过 DBeaver 手动插入

1. 在 `skus` 表中插入 SKU 信息
2. 在 `orders` 表中插入订单（status='pending'）
3. 在 `order_items` 表中插入订单明细

#### 方式二：使用 SQL 脚本

数据库首次启动时会自动执行 `backend/init_db.sql`，插入示例数据。

### 4. 运行排程

1. 确保数据库中有 `status='pending'` 的订单
2. 启动后端服务：`docker-compose up backend`
3. 调用 API：`POST http://localhost:8000/api/calculate`
4. 系统会自动从数据库读取订单并计算

## 测试

运行测试脚本验证数据库连接：

```bash
cd backend
python test_db_connection.py
```

## 兼容性说明

- ✅ **向后兼容**：原有的 Pydantic 模型（`OrderRequest`, `SKUInfo`）保持不变
- ✅ **接口兼容**：API 接口保持不变，只是数据源从 Mock 改为数据库
- ⚠️ **Mock 模块**：`backend/app/modules/mock/` 已废弃，但保留作为参考

## 环境变量

创建 `backend/.env` 文件（参考 `backend/.env.example`）：

```env
DATABASE_URL=postgresql://dreo_user:dreo_password@localhost:5432/dreo_logistics
```

在 Docker 环境中，`docker-compose.yml` 已自动配置环境变量。

## 故障排查

### 问题：无法连接数据库

1. 检查 PostgreSQL 容器是否运行：`docker ps | grep postgres`
2. 检查端口是否被占用：`netstat -an | grep 5432`
3. 查看容器日志：`docker logs dreo-postgres`

### 问题：表不存在

1. 运行初始化脚本：`python backend/app/init_database.py`
2. 或检查 `init_db.sql` 是否已执行

### 问题：查询返回空结果

1. 确认数据库中有数据：在 DBeaver 中查询 `SELECT * FROM orders WHERE status='pending'`
2. 检查订单状态是否为 'pending'
3. 确认订单明细已正确关联

## 后续优化建议

1. **数据验证**：添加数据完整性检查
2. **缓存机制**：对 SKU 信息进行缓存（Redis）
3. **批量操作**：优化批量插入订单的性能
4. **状态管理**：排程完成后自动更新订单状态
5. **数据迁移**：使用 Alembic 进行版本化数据库迁移


